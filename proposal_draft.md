# Google Summer of Code 2023: OpenCV Point Cloud Compression



## Personal Information

First/Last Name: Yuhang Wang

Email: yuhangwang0012@gmail.com

School/University: Southern University of Science and Technology

Graduation Date: June 2024

Major: Computer Science and Technology

Location: Shenzhen,China

Timezone: China Standard Time(CST), UTC+8

Git-hub Profile: [TsingYiPainter (Yuhang Wang) (github.com)](https://github.com/TsingYiPainter)

Open Source Experience:

​	-[OpenCV](https://github.com/opencv/opencv/pull/22682): Handling cases where the depth of Octree setting is too large



## Project Info

- Name: Point Cloud Data Compression
- Description: A point cloud compression algorithm with optional precision to improve point cloud processing techniques in OpenCV-5.x.



## Proposal

### Motivation

- Due to our team members' current progress in point cloud data compression in OpenCV-5.x, this GSoC project is a perfect fit for our direction. Therefore, team members would like to better accomplish this task with a mentor in the relevant filed. 
- Through this project, we would be able to receive feedbacks from not only mentors but also developers to contribute to the open-source community.



### Design

#### Overview
![1](https://user-images.githubusercontent.com/83380147/226158195-0571cbf9-eb0e-4f15-8508-68cc1ffa6a7a.png)



The above figure demonstrates the procedure of compression and decompression of point cloud data.

The procedure consists of five steps:

1. Preprocessing: In order to avoid the precision error, discretization is necessary since the data is composed by continuous float numbers. The data is thus mapped to discrete space.
2. Construction of octree: Octree is applied to store the data. User can specify the precision according to actual demand, the precision argument decides the depth of the octree.
3. Serialization: The complete information of octree is encoded by bit stream. Techniques like occupancy code, direct coding mode are applied to improve compression rate. 
4. Entropy Coding: Since the zero-one distribution in the bit stream is not uniform, entropy encoding is applied for further improvement.
5. Outputs: Output a bit stream.



#### Building The Octree

![2](https://user-images.githubusercontent.com/83380147/226158202-1803e8d1-07ca-4e45-aeaf-eeed26c7ec2c.png)


First, the point cloud data is discretized: we insert all the points into a voxel coordinate system.

For example, when precision is set to 0.01, a point with coordinate `Point3f(0.251,0.502,0.753)`  would transform to  `Point3i(25,50,75)`.

Next, the smallest bounding cube with side length $2^d$(d is octree's depth) that contains the point positions in internal coordinates is calculated.

For example, if the boundary points are `Point3f(0.0, 0.0, 0.0)` and `Point3f(10.0, 10.0, 10.0)`, then the cube size would be 1024 and the included range would be `(0, 0, 0)` to `(10.24, 10.24, 10.24)`. The point ` (0.251, 0.502, 0.753) `  turns into `(25，50，75)` in the voxel system. Repeat the process for every point then the precision problem is easily solved. 



#### Methods to Encode/Decode Octree

Encoding is performed by serializing the octree to a byte vector. Each node of an octree can be represented by an occupancy code of eight bits, each bit representing whether a specific child is occupied (has a point in its volume). The byte vector is a sequence of occupancy codes generated by traversing in BFS order starting from the root. This order guarantees that we can reverse-build the same octree structure when decoding.

By using arithmetic entropy coding, the byte stream can be further compressed due to its non-uniform probability distribution. Our entropy encoder encodes and decodes the byte stream effectively.

Further achieving compression rate requires exploring spatial correlation (neighbor entropy coding), or choosing different coding methods. In practice, we find out that when octree's depth is deepened (to improve precision), most octree nodes is only occupied by one child, i.e. degenerate from subtree to a chain, because at that depth the space is finely separated by tiny octree nodes(like dense voxels), and points are isolated to each node, so no spatial correlation is taken into advantage. Thus, directly encoding the isolated points' positions is more efficient than using occupancy codes. This method is called "Direct Coding Mode" (DCM).



#### Methods to Encode Color

Our team are currently learning about Region-Adaptive Hierarchical Transform.



#### Current Progress

- Our team are familiar with octree related code in OpenCV-5.x and understand how it works. We have had an accepted pull request solving the octree depth error of OpenCV-5.x.
- Our team has developed a demo, which supports simple geometry compression.
- Our team has read a few papers and have some understanding of existing compression techniques such as DCM and double-buffering octree.
- Our team has been exploring the field of point cloud compression for six month under the guidance of Professor Shiqi Yu.



### Road Map and Milestones

1. Simple Geometry Encoding Based on Octree (Completed)

2. Direct Coding Mode 

3. Attribute Coding Based on RAHT

4. Double Buffering Octree



### Expect  Schedule

Prior - May 29

- Reading papers of point cloud compression algorithms
- Discussion with mentor about specific aspects of project

June 1-14

- Finish direct coding mode
- Discuss the completed plan for encoding color

June 16- July 10

- Finish encode color
- Discuss the completed plan for double buffering octree

July 10 - 28

- Finish double buffering octree	

August 1-14

- Test and improve the program
- Write a document for program 
- start working on Checkstyle check

August 15-28

- Write a summary article throughout the project
- some flexible time

